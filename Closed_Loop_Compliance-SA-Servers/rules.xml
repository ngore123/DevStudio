<?xml version="1.0" encoding="UTF-8"?>
<process>
   <process-def name=":Closed_Loop_Compliance-SA-Servers:rules">
      <sequence>
         <switch>
            <meta>
               <peer-location>
                  <location>any</location>
               </peer-location>
            </meta>
            <execute-all-applicable-cases>true</execute-all-applicable-cases>
            <case name="CLC - Open Incident and Change for compliance violation" applies-if-any-condition-true="false">
               <condition>
                  <document>
                     <input>
                        <from>inputevent</from>
                     </input>
                  </document>
                  <xpath-expression>
                     <xpath><![CDATA[//specific-trap-type/text()="1001" or //trap-type/text()='trapJobCompletion'='true']]></xpath>
                  </xpath-expression>
                  <gui-data>
                     <from><![CDATA[//specific-trap-type/text()="1001" or //trap-type/text()='trapJobCompletion']]></from>
                     <fromKey><![CDATA[2975]]></fromKey>
                     <to><![CDATA['true']]></to>
                     <operator><![CDATA[=]]></operator>
                     <type><![CDATA[String]]></type>
                  </gui-data>
               </condition>
               <condition>
                  <document>
                     <input>
                        <from>inputevent</from>
                     </input>
                  </document>
                  <xpath-expression>
                     <xpath><![CDATA[//varbind[oid=".1.3.6.1.4.1.12788.1.1.8"]/value/text()='5106']]></xpath>
                  </xpath-expression>
                  <gui-data>
                     <from><![CDATA[//varbind[oid=".1.3.6.1.4.1.12788.1.1.8"]/value/text()]]></from>
                     <fromKey><![CDATA[2976]]></fromKey>
                     <to><![CDATA['5106']]></to>
                     <operator><![CDATA[=]]></operator>
                     <type><![CDATA[String]]></type>
                  </gui-data>
               </condition>
               <sequence>
                  <schedule-job>
                     <parameters>
                        <input required="false">
                           <from>inputevent</from>
                           <to>inputevent</to>
                        </input>
                     </parameters>
                     <group>Closed_Loop_Compliance-SA-Servers</group>
                     <name-prefix>CLC - Open Incident and Change for compliance violation</name-prefix>
                     <process-name>:Closed_Loop_Compliance-SA-Servers:Open Incident and Change for Compliance Violation</process-name>
                  </schedule-job>
               </sequence>
            </case>
            <case name="CLC - Verify compliance" applies-if-any-condition-true="false">
               <condition>
                  <document>
                     <input>
                        <from>inputevent</from>
                     </input>
                  </document>
                  <xpath-expression>
                     <xpath><![CDATA[//varbind/value[preceding-sibling::oid/text()='.1.3.6.1.4.1.12788.1.1.8']/text()='30' or //varbind/value[preceding-sibling::oid/text()='.1.3.6.1.4.1.12788.1.1.8']/text()='200'='true']]></xpath>
                  </xpath-expression>
                  <gui-data>
                     <from><![CDATA[//varbind/value[preceding-sibling::oid/text()='.1.3.6.1.4.1.12788.1.1.8']/text()='30' or //varbind/value[preceding-sibling::oid/text()='.1.3.6.1.4.1.12788.1.1.8']/text()='200']]></from>
                     <fromKey><![CDATA[2977]]></fromKey>
                     <to><![CDATA['true']]></to>
                     <operator><![CDATA[=]]></operator>
                     <type><![CDATA[String]]></type>
                  </gui-data>
               </condition>
               <condition>
                  <document>
                     <input>
                        <from>inputevent</from>
                     </input>
                  </document>
                  <xpath-expression>
                     <xpath><![CDATA[//specific-trap-type/text()='1001' or //trap-type/text()='trapJobCompletion'='true']]></xpath>
                  </xpath-expression>
                  <gui-data>
                     <from><![CDATA[//specific-trap-type/text()='1001' or //trap-type/text()='trapJobCompletion']]></from>
                     <fromKey><![CDATA[2978]]></fromKey>
                     <to><![CDATA['true']]></to>
                     <operator><![CDATA[=]]></operator>
                     <type><![CDATA[String]]></type>
                  </gui-data>
               </condition>
               <sequence>
                  <schedule-job>
                     <parameters>
                        <input required="false">
                           <from>inputevent</from>
                           <to>inputevent</to>
                        </input>
                     </parameters>
                     <group>Closed_Loop_Compliance-SA-Servers</group>
                     <name-prefix>CLC - Verify compliance</name-prefix>
                     <process-name>:Closed_Loop_Compliance-SA-Servers:Verify Compliance Violation after Remediation</process-name>
                  </schedule-job>
               </sequence>
            </case>
            <case name="Remediate Compliance On Remedy Notification" applies-if-any-condition-true="false">
               <condition>
                  <document>
                     <input>
                        <from>inputevent</from>
                     </input>
                  </document>
                  <xpath-expression>
                     <xpath><![CDATA[(//form-name/text() = 'CHG:Infrastructure Change') and contains(//text/text(), 'Change ID:') and contains(//text/text(), 'Status: Scheduled Configuration Name: BLADELOGIC') and starts-with(//text/text(), 'Compliance')='true']]></xpath>
                  </xpath-expression>
                  <gui-data>
                     <from><![CDATA[(//form-name/text() = 'CHG:Infrastructure Change') and contains(//text/text(), 'Change ID:') and contains(//text/text(), 'Status: Scheduled Configuration Name: BLADELOGIC') and starts-with(//text/text(), 'Compliance')]]></from>
                     <fromKey><![CDATA[5737]]></fromKey>
                     <to><![CDATA['true']]></to>
                     <operator><![CDATA[=]]></operator>
                     <type><![CDATA[String]]></type>
                  </gui-data>
               </condition>
               <sequence>
                  <schedule-job>
                     <parameters>
                        <input required="false">
                           <from>inputevent</from>
                           <to>inputevent</to>
                        </input>
                     </parameters>
                     <group>Closed_Loop_Compliance-SA-Servers</group>
                     <name-prefix>Remediate Compliance On Remedy Notification</name-prefix>
                     <process-name>:Closed_Loop_Compliance-SA-Servers:Remediate Compliance Violation</process-name>
                  </schedule-job>
               </sequence>
            </case>
            <case name="Remediate Compliance for ServiceNow" applies-if-any-condition-true="false">
               <condition>
                  <document>
                     <input>
                        <from>inputevent</from>
                     </input>
                  </document>
                  <xpath-expression>
                     <xpath><![CDATA[starts-with(normalize-space(substring-after(//body/bodypart, "Short Description:")), "Bladelogic Compliance Change") and (starts-with(normalize-space(substring-after(//body/bodypart, "Approval Status:")), "Approved"))='true']]></xpath>
                  </xpath-expression>
                  <gui-data>
                     <from><![CDATA[starts-with(normalize-space(substring-after(//body/bodypart, "Short Description:")), "Bladelogic Compliance Change") and (starts-with(normalize-space(substring-after(//body/bodypart, "Approval Status:")), "Approved"))]]></from>
                     <fromKey><![CDATA[7041]]></fromKey>
                     <to><![CDATA['true']]></to>
                     <operator><![CDATA[=]]></operator>
                     <type><![CDATA[String]]></type>
                  </gui-data>
               </condition>
               <sequence>
                  <schedule-job>
                     <parameters>
                        <input required="false">
                           <from>inputevent</from>
                           <to>inputevent</to>
                        </input>
                     </parameters>
                     <group>Closed_Loop_Compliance-SA-Servers</group>
                     <name-prefix>Remediate Compliance for ServiceNow</name-prefix>
                     <process-name>:Closed_Loop_Compliance-SA-Servers:Remediate Compliance Violation</process-name>
                  </schedule-job>
               </sequence>
            </case>
            <case name="Remediate Compliance on email event" applies-if-any-condition-true="false">
               <condition>
                  <document>
                     <input>
                        <from>inputevent</from>
                     </input>
                  </document>
                  <xpath-expression>
                     <xpath><![CDATA[starts-with(//subject, "Closed_Loop_Compliance_Test")='true']]></xpath>
                  </xpath-expression>
                  <gui-data>
                     <from><![CDATA[starts-with(//subject, "Closed_Loop_Compliance_Test")]]></from>
                     <fromKey><![CDATA[5749]]></fromKey>
                     <to><![CDATA['true']]></to>
                     <operator><![CDATA[=]]></operator>
                     <type><![CDATA[String]]></type>
                  </gui-data>
               </condition>
               <sequence>
                  <schedule-job>
                     <parameters>
                        <input required="false">
                           <from>inputevent</from>
                           <to>inputevent</to>
                        </input>
                     </parameters>
                     <group>Closed_Loop_Compliance-SA-Servers</group>
                     <name-prefix>Remediate Compliance on email event</name-prefix>
                     <process-name>:Closed_Loop_Compliance-SA-Servers:Remediate Compliance Violation</process-name>
                  </schedule-job>
               </sequence>
            </case>
         </switch>
      </sequence>
      <meta>
         <peer-location>
            <location>any</location>
         </peer-location>
      </meta>
      <parameters>
         <input>
            <from>inputevent</from>
            <to>inputevent</to>
         </input>
      </parameters>
   </process-def>
</process>

